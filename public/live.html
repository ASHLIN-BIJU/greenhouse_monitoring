<!DOCTYPE html>
<html>

<head>
    <title>Live Sensor Monitor</title>
    <style>
        :root {
            --primary: #2ecc71;
            --bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Arial;
            text-align: center;
            background: var(--bg);
            padding: 40px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .connecting {
            background: #ffeaa7;
            color: #d63031;
        }

        .connected {
            background: #dff9fb;
            color: #0984e3;
        }

        .reading-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .box {
            background: #fdfdfd;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 15px;
            transition: 0.3s;
        }

        .box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .label {
            display: block;
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .value-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sub-box {
            padding: 10px;
            border-radius: 10px;
        }

        .actual {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .target {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .value {
            font-size: 28px;
            font-weight: bold;
        }

        .unit {
            font-size: 14px;
            opacity: 0.7;
        }

        .sub-label {
            font-size: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ðŸŒ¿ Greenhouse Real-time Monitor</h1>
        <div id="status" class="status connecting">Connecting to WebSocket...</div>

        <div class="reading-grid">
            <!-- Temperature -->
            <div class="box">
                <span class="label">ðŸŒ¡ Temperature</span>
                <div class="value-group">
                    <div class="sub-box actual">
                        <span class="sub-label">Now</span>
                        <span class="value" id="temp">--</span><span class="unit">Â°C</span>
                    </div>
                    <div class="sub-box target">
                        <span class="sub-label">Target</span>
                        <span class="value" id="temp_target">--</span><span class="unit">Â°C</span>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div class="box">
                <span class="label">ðŸ’§ Humidity</span>
                <div class="value-group">
                    <div class="sub-box actual">
                        <span class="sub-label">Now</span>
                        <span class="value" id="hum">--</span><span class="unit">%</span>
                    </div>
                    <div class="sub-box target">
                        <span class="sub-label">Target</span>
                        <span class="value" id="hum_target">--</span><span class="unit">%</span>
                    </div>
                </div>
            </div>

            <!-- Soil Moisture -->
            <div class="box">
                <span class="label">ðŸŒ± Soil Moisture</span>
                <div class="value-group">
                    <div class="sub-box actual">
                        <span class="sub-label">Now</span>
                        <span class="value" id="soil">--</span><span class="unit">%</span>
                    </div>
                    <div class="sub-box target">
                        <span class="sub-label">Target</span>
                        <span class="value" id="soil_target">--</span><span class="unit">%</span>
                    </div>
                </div>
            </div>
        </div>

        <p style="margin-top: 30px; font-size: 12px; color: #bdc3c7;">Persisting 100% of sensor changes to database.
            Monitoring User ID: 6</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/laravel-echo/dist/echo.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pusher-js/dist/web/pusher.min.js"></script>

    <script>
        window.Pusher = Pusher;

        // ðŸ” CONFIGURATION
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId') || 6;
        const token = urlParams.get('token');
        const REVERB_KEY = 'pyagbybv7uh9d8scjusx';

        console.log(`Config: User=${userId}, Token=${token ? 'Present' : 'None'}`);

        const echo = new Echo({
            broadcaster: 'reverb',
            key: REVERB_KEY,
            wsHost: window.location.hostname === 'localhost' ? '127.0.0.1' : window.location.hostname,
            wsPort: 8080,
            forceTLS: false,
            disableStats: true,
            enabledTransports: ['ws', 'wss']
        });

        const statusEl = document.getElementById('status');

        const updateActual = (data) => {
            if (!data) return;
            document.getElementById('temp').innerText = data.temperature ? parseFloat(data.temperature).toFixed(1) : '--';
            document.getElementById('hum').innerText = data.humidity ? parseFloat(data.humidity).toFixed(1) : '--';
            document.getElementById('soil').innerText = data.soil_moisture ? parseFloat(data.soil_moisture).toFixed(1) : '--';
        };

        const updateTarget = (data) => {
            if (!data) return;
            document.getElementById('temp_target').innerText = data.temperature ? parseFloat(data.temperature).toFixed(1) : '--';
            document.getElementById('hum_target').innerText = data.humidity ? parseFloat(data.humidity).toFixed(1) : '--';
            document.getElementById('soil_target').innerText = data.soil_moisture ? parseFloat(data.soil_moisture).toFixed(1) : '--';
        };

        // Connection Event
        console.log("Setting up echo for user:", userId);

        echo.connector.pusher.connection.bind('connected', () => {
            statusEl.innerText = `Connected to Live Feed (User ${userId})`;
            statusEl.className = "status connected";
            console.log("Successfully connected to Reverb!");
        });

        echo.connector.pusher.connection.bind('error', (err) => {
            statusEl.innerText = "Connection Error!";
            statusEl.className = "status connecting";
            console.error("WebSocket Error:", err);
        });

        echo.channel(`sensor.${userId}`)
            .listen('SensorUpdated', (e) => {
                console.log("New data received:", e);
                updateActual(e.data.actual);
                updateTarget(e.data.target);
            });

        // INITIAL FETCHING
        async function fetchInitialData() {
            if (!token) {
                console.warn("No token provided in URL (?token=...). Skipping initial fetch.");
                return;
            }

            try {
                // Fetch Latest Reading
                const readingRes = await fetch(`/api/sensor/latest`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });
                if (readingRes.ok) {
                    const reading = await readingRes.json();
                    updateActual(reading);
                }

                // Fetch Target Settings
                const settingsRes = await fetch(`/api/settings`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });
                if (settingsRes.ok) {
                    const settings = await settingsRes.json();
                    updateTarget(settings);
                }
            } catch (err) {
                console.error("Failed to fetch initial data:", err);
            }
        }

        fetchInitialData();
    </script>

</body>

</html>